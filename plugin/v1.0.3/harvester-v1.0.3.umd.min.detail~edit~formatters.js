(("undefined"!==typeof self?self:this)["webpackJsonpharvester_v1_0_3"]=("undefined"!==typeof self?self:this)["webpackJsonpharvester_v1_0_3"]||[]).push([[0],{"4b06":function(e,t,s){"use strict";s.d(t,"a",(function(){return v})),s.d(t,"b",(function(){return m}));var a=s("7838"),i=s.n(a),n=s("9e74"),r=s.n(n),o=s("1832"),l=s("56a4"),u=s("90cd"),c=s("b0bd"),d=s("6834"),v={package_update:!0,packages:["qemu-guest-agent"],runcmd:[["systemctl","enable","--now","qemu-guest-agent.service"]]},h={default:"qemu-guest-agent.service"},m=[{bus:"usb",name:"tablet",type:"tablet"}],p={EXISTING_ALL:"EXISTING_ALL",EXISTING_ONLY_ANNOTATION:"EXISTING_ANNOTATION",EXISTING_ONLY_CLOUD:"EXISTING_CLOUD"};t["c"]={methods:{getSSHValue:function(e){var t,s,a=this.$store.getters["harvester/all"](u["a"].SSH)||[];return(null===(t=a.find((function(t){return t.id===e})))||void 0===t||null===(s=t.spec)||void 0===s?void 0:s.publicKey)||void 0},getOsType:function(e){var t,s;return null===(t=e.metadata)||void 0===t||null===(s=t.labels)||void 0===s?void 0:s[c["l"].OS]},getMatchQGA:function(e){var t=Object(o["clone"])(v),s=!1;return d["b"].forEach((function(t){t.match&&(s=t.match.find((function(t){return t===e})))})),t.runcmd[0][3]=s?h[e]:h["default"],t},getSimilarRuncmd:function(e){var t=Object(o["clone"])(v);return t.runcmd[0][3]="openSUSE"===e?h["default"]:h["suse"],t.runcmd[0]},hasInstallAgent:function(e,t,s){var a,n,r,o,l={},u=this.getMatchQGA(t);try{l=i.a.load(e)||{}}catch(c){return new Error("Function(hasInstallAgent) error"),s}return(null===(a=l)||void 0===a||null===(n=a.packages)||void 0===n?void 0:n.includes("qemu-guest-agent"))&&!(null===(r=l)||void 0===r||null===(o=r.runcmd)||void 0===o||!o.find((function(e){return Array.isArray(e)&&e.join("-")===u.runcmd[0].join("-")})))},isInstallUSBTablet:function(e){var t,s,a,i,n=null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(a=s.domain)||void 0===a||null===(i=a.devices)||void 0===i?void 0:i.inputs;return!!Array.isArray(n)&&!!n.find((function(e){return r()(e,m[0])}))},isEfiEnabled:function(e){var t,s,a,i,n,r,o,l,u;return!(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(a=s.domain)||void 0===a||null===(i=a.features)||void 0===i||!i.smm||null===e||void 0===e||null===(n=e.template)||void 0===n||null===(r=n.spec)||void 0===r||null===(o=r.domain)||void 0===o||null===(l=o.firmware)||void 0===l||null===(u=l.bootloader)||void 0===u||!u.efi)},isSecureBoot:function(e){var t,s,a,i,n,r;return!(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(a=s.domain)||void 0===a||null===(i=a.firmware)||void 0===i||null===(n=i.bootloader)||void 0===n||null===(r=n.efi)||void 0===r||!r.secureBoot)},getSecretCloudData:function(e,t){var s,a,i=this.getSecret(e),n=null===i||void 0===i||null===(s=i.decodedData)||void 0===s?void 0:s.userdata,r=null===i||void 0===i||null===(a=i.decodedData)||void 0===a?void 0:a.networkdata;return{userData:n,networkData:r}},getSecret:function(e){var t,s,a,i,n,r,o=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(a=s.volumes)||void 0===a||null===(i=a.find((function(e){return"cloudinitdisk"===e.name})))||void 0===i?void 0:i.cloudInitNoCloud)||{},u=this.$store.getters["harvester/all"](l["E"])||[],c=(null===o||void 0===o||null===(n=o.secretRef)||void 0===n?void 0:n.name)||(null===o||void 0===o||null===(r=o.networkDataSecretRef)||void 0===r?void 0:r.name),d=u.find((function(e){return e.metadata.name===c}));return d},getAccessCredentials:function(e){var t,s,a,i,n=this.$store.getters["harvester/all"](l["E"])||[],r=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s?void 0:s.accessCredentials)||[],o=JSON.parse((null===(a=e.template.metadata)||void 0===a||null===(i=a.annotations)||void 0===i?void 0:i[c["l"].DYNAMIC_SSHKEYS_NAMES])||"[]");return r.map((function(e){var t,s,a,i=e.userPassword?"userPassword":"sshPublicKey",r=null===(t=e[i])||void 0===t||null===(s=t.source)||void 0===s||null===(a=s.secret)||void 0===a?void 0:a.secretName,l=n.find((function(e){return e.metadata.name===r})),u={source:i,username:"",newPassword:"",users:[],sshkeys:[],secretName:r,secretRef:l};if(l)if("userPassword"===i){var c=Object.keys(null===l||void 0===l?void 0:l.data)[0],d=l.decodedData[c];u.username=c,u.newPassword=d}else{var v=e[i].propagationMethod.qemuGuestAgent.users,h=null===o||void 0===o?void 0:o[r];u.users=v,u.sshkeys=h}else u.secretRef=void 0;return u}))},getVolumeClaimTemplates:function(e){var t=[];try{t=JSON.parse(e.metadata.annotations[c["l"].VOLUME_CLAIM_TEMPLATE])}catch(s){new Error("Function: getVolumeClaimTemplates, ".concat(s))}return t},getRootImageId:function(e){var t,s,a,i=this.getVolumeClaimTemplates(e);return(null===(t=i[0])||void 0===t||null===(s=t.metadata)||void 0===s||null===(a=s.annotations)||void 0===a?void 0:a[c["l"].IMAGE_ID])||""},getSSHFromAnnotation:function(e){var t,s,a,i=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.metadata)||void 0===s||null===(a=s.annotations)||void 0===a?void 0:a[c["l"].SSH_NAMES])||"[]";return JSON.parse(i)},convertToJson:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t={};try{t=i.a.load(e)}catch(s){new Error("Function(convertToJson) error")}return t},getSSHFromUserData:function(e){var t;return(null===(t=this.convertToJson(e))||void 0===t?void 0:t.ssh_authorized_keys)||[]},compareSSHValue:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=/(\r\n\t|\n|\r\t)|(\s*)/gm;return e.replace(s,"")===t.replace(s,"")},mergeAllSSHs:function(e){var t=this,s=this.getSSHFromAnnotation(e),a=this.getSecretCloudData(e),i=a.userScript;if(!(null!==s&&void 0!==s&&s.length)<0&&!i)return[];var n=[],r=this.$store.getters["harvester/all"](u["a"].SSH)||[];n=(s||[]).map((function(e){var t=r.find((function(t){return t.id===e}));return t?{id:t.id,data:t,type:p.EXISTING_ALL}:{id:e,data:e,type:p.EXISTING_ONLY_ANNOTATION}}));var o=this.getSSHFromUserData(i);return o.map((function(e){var s=r.find((function(s){var a;return t.compareSSHValue(e,null===(a=s.spec)||void 0===a?void 0:a.publicKey)}));s&&!n.find((function(e){return e.id===s.id}))?n.push({id:s.id,data:s,type:p.EXISTING_ALL}):s||n.push({id:"Unknown",data:e,type:p.EXISTING_ONLY_CLOUD})})),n}}}},6834:function(e,t,s){"use strict";s.d(t,"a",(function(){return j})),s.d(t,"b",(function(){return G}));var a=s("56d4"),i=s.n(a),n=s("e3b5"),r=s("7838"),o=s.n(r),l=s("9e74"),u=s.n(l),c=s("330a"),d=s.n(c),v=s("94a3"),h=s.n(v),m=s("7592"),p=s("1832"),f=s("b837"),g=s("06f6"),S=s("8672"),y=s("67ab"),b=s("7c47"),A=s("d6a6"),w=s("56a4"),E=s("90cd"),k=s("fa85"),N=s("b0bd"),I=s("4b06");function M(e,t){var s="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!s){if(Array.isArray(e)||(s=C(e))||t&&e&&"number"===typeof e.length){s&&(e=s);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,r=!0,o=!1;return{s:function(){s=s.call(e)},n:function(){var e=s.next();return r=e.done,e},e:function(e){o=!0,n=e},f:function(){try{r||null==s.return||s.return()}finally{if(o)throw n}}}}function O(e){return _(e)||D(e)||C(e)||T()}function T(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function C(e,t){if(e){if("string"===typeof e)return $(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);return"Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s?Array.from(e):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?$(e,t):void 0}}function D(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _(e){if(Array.isArray(e))return $(e)}function $(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,a=new Array(t);s<t;s++)a[s]=e[s];return a}function V(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,a)}return s}function R(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?V(Object(s),!0).forEach((function(t){P(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function P(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function x(e,t,s,a,i,n,r){try{var o=e[n](r),l=o.value}catch(u){return void s(u)}o.done?t(l):Promise.resolve(l).then(a,i)}function U(e){return function(){var t=this,s=arguments;return new Promise((function(a,i){var n=e.apply(t,s);function r(e){x(n,a,i,r,o,"next",e)}function o(e){x(n,a,i,r,o,"throw",e)}r(void 0)}))}}var j="management Network",G=[{label:"Windows",value:"windows"},{label:"Linux",value:"linux"},{label:"Debian",value:"debian"},{label:"Fedora",value:"fedora"},{label:"Gentoo",value:"gentoo"},{label:"Mandriva",value:"mandriva"},{label:"Oracle",value:"oracle"},{label:"Red Hat",value:"redhat"},{label:"openSUSE",value:"openSUSE"},{label:"Turbolinux",value:"turbolinux"},{label:"Ubuntu",value:"ubuntu"},{label:"Xandros",value:"xandros"},{label:"Other Linux",match:["centos"],value:"otherLinux"}],L="cd-rom",H="disk";t["c"]={mixins:[I["c"]],props:{value:{type:Object,required:!0},resource:{type:String,default:""}},fetch:function(){var e=this;return U(i.a.mark((function t(){var s;return i.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return s={pvcs:e.$store.dispatch("harvester/findAll",{type:w["A"]}),storageClasses:e.$store.dispatch("harvester/findAll",{type:w["J"]}),sshs:e.$store.dispatch("harvester/findAll",{type:E["a"].SSH}),settings:e.$store.dispatch("harvester/findAll",{type:E["a"].SETTING}),images:e.$store.dispatch("harvester/findAll",{type:E["a"].IMAGE}),versions:e.$store.dispatch("harvester/findAll",{type:E["a"].VM_VERSION}),templates:e.$store.dispatch("harvester/findAll",{type:E["a"].VM_TEMPLATE}),networkAttachment:e.$store.dispatch("harvester/findAll",{type:w["u"]}),vmis:e.$store.dispatch("harvester/findAll",{type:E["a"].VMI}),vmims:e.$store.dispatch("harvester/findAll",{type:E["a"].VMIM}),vms:e.$store.dispatch("harvester/findAll",{type:E["a"].VM}),secrets:e.$store.dispatch("harvester/findAll",{type:w["E"]})},e.$store.getters["harvester/schemaFor"](w["w"])&&(s.nodes=e.$store.dispatch("harvester/findAll",{type:w["w"]})),t.next=4,Object(f["a"])(s);case 4:case"end":return t.stop()}}),t)})))()},data:function(){var e=this.realMode===A["s"];return{OS:G,isClone:e,spec:null,osType:"linux",sshKey:[],runStrategy:"RerunOnFailure",installAgent:!0,hasCreateVolumes:[],installUSBTablet:!0,networkScript:"",userScript:"",imageId:"",diskRows:[],networkRows:[],machineType:"",secretName:"",secretRef:null,showAdvanced:!1,deleteAgent:!0,memory:null,cpu:"",reservedMemory:null,accessCredentials:[],efiEnabled:!1,secureBoot:!1,userDataTemplateId:""}},computed:{images:function(){return this.$store.getters["harvester/all"](E["a"].IMAGE)},versions:function(){return this.$store.getters["harvester/all"](E["a"].VM_VERSION)},templates:function(){return this.$store.getters["harvester/all"](E["a"].VM_TEMPLATE)},pvcs:function(){return this.$store.getters["harvester/all"](w["A"])},secrets:function(){return this.$store.getters["harvester/all"](w["E"])},nodesIdOptions:function(){var e=this.$store.getters["harvester/all"](w["w"]);return e.filter((function(e){return!e.isUnSchedulable})).map((function(e){return{label:e.nameDisplay,value:e.id}}))},defaultStorageClass:function(){var e,t=this.$store.getters["harvester/all"](w["J"]).find((function(e){return e.isDefault}));return(null===t||void 0===t||null===(e=t.metadata)||void 0===e?void 0:e.name)||"longhorn"},storageClassSetting:function(){try{var e,t=null===(e=this.$store.getters["harvester/all"](E["a"].SETTING).find((function(e){return e.id===k["b"].DEFAULT_STORAGE_CLASS})))||void 0===e?void 0:e.value;return JSON.parse(t)}catch(s){return{}}},customDefaultStorageClass:function(){return this.storageClassSetting.storageClass},customVolumeMode:function(){return this.storageClassSetting.volumeMode||"Block"},customAccessMode:function(){return this.storageClassSetting.accessModes||"ReadWriteMany"},isWindows:function(){return"windows"===this.osType},needNewSecret:function(){return this.resource===E["a"].VM_VERSION||this.isCreate}},created:function(){var e=this;return U(i.a.mark((function t(){return i.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$store.dispatch("harvester/findAll",{type:w["E"]});case 2:e.getInitConfig({value:e.value});case 3:case"end":return t.stop()}}),t)})))()},methods:{getInitConfig:function(e){var t,s,a,i,n,r,o,l=e.value,u=this.resource===E["a"].VM?l:this.resource===E["a"].BACKUP?null===(t=this.value.status)||void 0===t?void 0:t.source:l.spec.vm,c=null===u||void 0===u?void 0:u.spec;if(c){var d=c.template.spec.domain.resources;null!==d&&void 0!==d&&d.limits&&(null===d||void 0===d||!d.limits||null!==d&&void 0!==d&&null!==(s=d.limits)&&void 0!==s&&s.memory||null===(null===d||void 0===d||null===(a=d.limits)||void 0===a?void 0:a.memory))||(c.template.spec.domain.resources=R(R({},c.template.spec.domain.resources),{},{limits:R(R({},c.template.spec.domain.resources.limits),{},{memory:c.template.spec.domain.resources.requests.memory})}));var v=c.runStrategy||"RerunOnFailure",h=l.machineType,m=null===(i=c.template.spec.domain)||void 0===i||null===(n=i.cpu)||void 0===n?void 0:n.cores,p=c.template.spec.domain.resources.limits.memory,f=null===(r=u.metadata)||void 0===r||null===(o=r.annotations)||void 0===o?void 0:o[N["l"].VM_RESERVED_MEMORY],g=this.getSSHFromAnnotation(c)||[],y=this.getRootImageId(u)||"",b=this.getDiskRows(u),A=this.getNetworkRows(u),w=this.getHasCreatedVolumes(c)||[],k=this.getSecretCloudData(c),I=k.userData,M=void 0===I?void 0:I,O=k.networkData,T=void 0===O?void 0:O;if(this.resource===E["a"].BACKUP){var C,D=null===(C=this.value.status)||void 0===C?void 0:C.secretBackups;if(D){var _,$,V,P,x=(null===(_=D[0])||void 0===_||null===($=_.data)||void 0===$?void 0:$.networkdata)||"",U=(null===(V=D[0])||void 0===V||null===(P=V.data)||void 0===P?void 0:P.userdata)||"";M=Object(S["a"])(U),T=Object(S["a"])(x)}}var j=this.getOsType(u)||"linux";M=this.isCreate?this.getInitUserData({osType:j}):M;var G=this.isInstallUSBTablet(c),L=!!this.isCreate||this.hasInstallAgent(M,j,!0),H=this.isEfiEnabled(c),B=this.isSecureBoot(c),Y=this.getSecret(c),K=this.getAccessCredentials(c);Object.prototype.hasOwnProperty.call(c,"running")&&(delete c.running,c.runStrategy="RerunOnFailure"),this.$set(this,"spec",c),this.$set(this,"runStrategy",v),this.$set(this,"secretRef",Y),this.$set(this,"accessCredentials",K),this.$set(this,"userScript",M),this.$set(this,"networkScript",T),this.$set(this,"sshKey",g),this.$set(this,"osType",j),this.$set(this,"installAgent",L),this.$set(this,"cpu",m),this.$set(this,"memory",p),this.$set(this,"reservedMemory",f),this.$set(this,"machineType",h),this.$set(this,"installUSBTablet",G),this.$set(this,"efiEnabled",H),this.$set(this,"secureBoot",B),this.$set(this,"hasCreateVolumes",w),this.$set(this,"networkRows",A),this.$set(this,"imageId",y),this.$set(this,"diskRows",b)}},getDiskRows:function(e){var t=this,s=e.metadata.namespace,a=e.spec.template.spec.volumes||[],i=e.spec.template.spec.domain.devices.disks||[],n=this.getVolumeClaimTemplates(e),r=[];return 0===i.length?r.push({id:Object(g["p"])(5),source:b["d"].IMAGE,name:"disk-0",accessMode:"ReadWriteMany",bus:"virtio",volumeName:"",size:"10Gi",type:H,storageClassName:"",image:this.imageId,volumeMode:"Block"}):r=i.map((function(i,r){var o,l,u,c,d,v=a.find((function(e){return e.name===i.name})),h="",m="",p="",f="",S="",A="",E="",k="",I="",M=!1,O=null!==i&&void 0!==i&&i.cdrom?L:H;if(null!==v&&void 0!==v&&v.containerDisk&&(p=b["d"].CONTAINER,S=v.containerDisk.image),v.persistentVolumeClaim&&null!==(o=v.persistentVolumeClaim)&&void 0!==o&&o.claimName){A=v.persistentVolumeClaim.claimName;var T=n.find((function(e){return e.metadata.name===A}));if(f=A,T){var C,D,_,$,V,R,P;if(void 0!==(null===(C=T.metadata)||void 0===C||null===(D=C.annotations)||void 0===D?void 0:D[N["l"].IMAGE_ID]))m=null===(R=T.metadata)||void 0===R||null===(P=R.annotations)||void 0===P?void 0:P[N["l"].IMAGE_ID],p=b["d"].IMAGE;else p=b["d"].NEW;var x=(null===T||void 0===T?void 0:T.spec)||{};k=null===x||void 0===x?void 0:x.volumeMode,E=null===x||void 0===x||null===(_=x.accessModes)||void 0===_?void 0:_[0],h=(null===x||void 0===x||null===($=x.resources)||void 0===$||null===(V=$.requests)||void 0===V?void 0:V.storage)||"10Gi",I=null===x||void 0===x?void 0:x.storageClassName}else{var U,j,G,B,Y,K,J,F,q=t.$store.getters["harvester/all"](w["A"]),z=q.find((function(e){var t;return e.id==="".concat(s,"/").concat(null===v||void 0===v||null===(t=v.persistentVolumeClaim)||void 0===t?void 0:t.claimName)}));p=b["d"].ATTACH_VOLUME,E=(null===z||void 0===z||null===(U=z.spec)||void 0===U||null===(j=U.accessModes)||void 0===j?void 0:j[0])||"ReadWriteMany",h=(null===z||void 0===z||null===(G=z.spec)||void 0===G||null===(B=G.resources)||void 0===B||null===(Y=B.requests)||void 0===Y?void 0:Y.storage)||"10Gi",I=null===z||void 0===z||null===(K=z.spec)||void 0===K?void 0:K.storageClassName,k=(null===z||void 0===z||null===(J=z.spec)||void 0===J?void 0:J.volumeMode)||"Block",A=(null===z||void 0===z||null===(F=z.metadata)||void 0===F?void 0:F.name)||""}M=v.persistentVolumeClaim.hotpluggable||!1}var W=(null===i||void 0===i||null===(l=i.disk)||void 0===l?void 0:l.bus)||(null===i||void 0===i||null===(u=i.cdrom)||void 0===u?void 0:u.bus),X=null!==i&&void 0!==i&&i.bootOrder?null===i||void 0===i?void 0:i.bootOrder:r,Q=Object(y["f"])(h),Z=Object(y["e"])(Q,{increment:1024,addSuffix:!1,maxExponent:3,minExponent:3}),ee=JSON.parse((null===(c=e.metadata)||void 0===c||null===(d=c.annotations)||void 0===d?void 0:d[N["l"].VM_VOLUME_STATUS])||"[]"),te=ee.find((function(e){return f===e.name}));return{id:Object(g["p"])(5),bootOrder:X,source:p,name:i.name,realName:f,bus:W,volumeName:A,container:S,accessMode:E,size:"".concat(Z,"Gi"),volumeMode:k||t.customVolumeMode,image:m,type:O,storageClassName:I,hotpluggable:M,volumeStatus:te}})),r=Object(m["b"])(r,"bootOrder"),r.filter((function(e){return"cloudinitdisk"!==e.name}))},getNetworkRows:function(e){var t=e.spec.template.spec.networks||[],s=e.spec.template.spec.domain.devices.interfaces||[],a=s.map((function(e,s){var a,i=t.find((function(t){return e.name===t.name})),n=e.sriov?"sriov":e.bridge?"bridge":"masquerade",r=!!i.pod;return R(R({},e),{},{index:s,type:n,isPod:r,model:e.model,networkName:r?j:null===i||void 0===i||null===(a=i.multus)||void 0===a?void 0:a.networkName})}));return a},parseVM:function(){this.parseOther(),this.parseAccessCredentials(),this.parseNetworkRows(this.networkRows),this.parseDiskRows(this.diskRows)},parseOther:function(){this.spec.template.spec.domain.machine?this.$set(this.spec.template.spec.domain.machine,"type",this.machineType):this.$set(this.spec.template.spec.domain,"machine",{type:this.machineType}),this.spec.template.spec.domain.cpu.cores=this.cpu,this.spec.template.spec.domain.resources.limits.cpu=this.cpu,this.spec.template.spec.domain.resources.limits.memory=this.memory;var e=this.resource===E["a"].VM?this.value:this.value.spec.vm;this.reservedMemory?e.metadata.annotations[N["l"].VM_RESERVED_MEMORY]=this.reservedMemory:delete e.metadata.annotations[N["l"].VM_RESERVED_MEMORY]},parseDiskRows:function(e){var t,s,a,i,n,r,o,l,u,c,d,v,h,m,p,f,S=this,y=[],A=[],w=[],k=[];e.forEach((function(e,t){var s,a=(null===(s=S.value.metadata)||void 0===s?void 0:s.name)||"",i="";i=e.source===b["d"].ATTACH_VOLUME?e.volumeName:S.isClone||!S.hasCreateVolumes.includes(e.realName)?"".concat(a,"-").concat(e.name,"-").concat(Object(g["p"])(5).toLowerCase()):e.realName;var n=S.parseDisk(e,t),r=S.parseVolume(e,i),o=S.parseVolumeClaimTemplate(e,i);y.push(n),A.push(r),w.push(i),e.source!==b["d"].CONTAINER&&e.source!==b["d"].ATTACH_VOLUME&&k.push(o)})),this.secretName&&!this.needNewSecret||(this.secretName=this.generateSecretName(this.secretNamePrefix)),y.find((function(e){return"cloudinitdisk"===e.name}))||this.isWindows||(y.push({name:"cloudinitdisk",disk:{bus:"virtio"}}),A.push({name:"cloudinitdisk",cloudInitNoCloud:{secretRef:{name:this.secretName},networkDataSecretRef:{name:this.secretName}}}));var I,M,O=R(R({},this.spec),{},{runStrategy:this.runStrategy,template:R(R({},this.spec.template),{},{metadata:R(R({},null===(t=this.spec)||void 0===t||null===(s=t.template)||void 0===s?void 0:s.metadata),{},{annotations:R(R({},null===(a=this.spec)||void 0===a||null===(i=a.template)||void 0===i||null===(n=i.metadata)||void 0===n?void 0:n.annotations),{},P({},N["l"].SSH_NAMES,JSON.stringify(this.sshKey))),labels:R(R({},null===(r=this.spec)||void 0===r||null===(o=r.template)||void 0===o||null===(l=o.metadata)||void 0===l?void 0:l.labels),{},P({},N["l"].VM_NAME,null===(u=this.value)||void 0===u||null===(c=u.metadata)||void 0===c?void 0:c.name))}),spec:R(R({},null===(d=this.spec.template)||void 0===d?void 0:d.spec),{},{domain:R(R({},null===(v=this.spec.template)||void 0===v||null===(h=v.spec)||void 0===h?void 0:h.domain),{},{devices:R(R({},null===(m=this.spec.template)||void 0===m||null===(p=m.spec)||void 0===p||null===(f=p.domain)||void 0===f?void 0:f.devices),{},{disks:y})}),volumes:A})})});(0===A.length&&delete O.template.spec.volumes,this.resource===E["a"].VM)?(this.isSingle||(O=this.multiVMScheduler(O)),this.$set(this.value.metadata,"annotations",R(R({},this.value.metadata.annotations),{},(I={},P(I,N["l"].VOLUME_CLAIM_TEMPLATE,JSON.stringify(k)),P(I,N["l"].NETWORK_IPS,JSON.stringify(this.value.networkIps)),I))),this.$set(this.value.metadata,"labels",R(R({},this.value.metadata.labels),{},(M={},P(M,N["l"].CREATOR,"harvester"),P(M,N["l"].OS,this.osType),M))),this.$set(this.value,"spec",O),this.$set(this,"spec",O)):this.resource===E["a"].VM_VERSION&&(this.$set(this.value.spec.vm,"spec",O),this.$set(this.value.spec.vm.metadata,"annotations",R(R({},this.value.spec.vm.metadata.annotations),{},P({},N["l"].VOLUME_CLAIM_TEMPLATE,JSON.stringify(k)))),this.$set(this.value.spec.vm.metadata,"labels",P({},N["l"].OS,this.osType)),this.$set(this,"spec",O))},multiVMScheduler:function(e){var t,s,a,i,n;e.template.metadata.labels[N["l"].VM_NAME_PREFIX]=this.namePrefix;var r={weight:1,podAffinityTerm:{topologyKey:N["m"],labelSelector:{matchLabels:P({},N["l"].VM_NAME_PREFIX,this.namePrefix)}}};return R(R({},e),{},{template:R(R({},e.template),{},{spec:R(R({},e.template.spec),{},{affinity:R(R({},e.template.spec.affinity),{},{podAntiAffinity:R(R({},null===(t=e.template.spec)||void 0===t||null===(s=t.affinity)||void 0===s?void 0:s.podAntiAffinity),{},{preferredDuringSchedulingIgnoredDuringExecution:[].concat(O((null===(a=e.template.spec)||void 0===a||null===(i=a.affinity)||void 0===i||null===(n=i.podAntiAffinity)||void 0===n?void 0:n.preferredDuringSchedulingIgnoredDuringExecution)||[]),[r])})})})})})},parseNetworkRows:function(e){var t=this,s=[],a=[];e.forEach((function(e){var i=t.parseNetwork(e),n=t.parseInterface(e);s.push(i),a.push(n)}));var i=R(R({},this.spec.template.spec),{},{domain:R(R({},this.spec.template.spec.domain),{},{devices:R(R({},this.spec.template.spec.domain.devices),{},{interfaces:a})}),networks:s});this.$set(this.spec.template,"spec",i)},parseAccessCredentials:function(){var e,t,s,a,i,n=[],r={},o=JSON.parse((null===(e=this.spec)||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.metadata)||void 0===s||null===(a=s.annotations)||void 0===a?void 0:a[N["l"].DYNAMIC_SSHKEYS_USERS])||"[]"),l=M(this.accessCredentials);try{for(l.s();!(i=l.n()).done;){var u=i.value;this.needNewSecret&&(u.secretName=this.generateSecretName(this.secretNamePrefix)),u.source===b["a"].RESET_PWD&&(o.push(u.username),n.push({userPassword:{source:{secret:{secretName:u.secretName}},propagationMethod:{qemuGuestAgent:{}}}})),u.source===b["a"].INJECT_SSH&&(o.push.apply(o,O(u.users)),r[u.secretName]=u.sshkeys,n.push({sshPublicKey:{source:{secret:{secretName:u.secretName}},propagationMethod:{qemuGuestAgent:{users:u.users}}}}))}}catch(c){l.e(c)}finally{l.f()}0===n.length&&this.spec.template.spec.accessCredentials?delete this.spec.template.spec.accessCredentials:this.spec.template.spec.accessCredentials=n,0!==o.length&&(this.spec.template.metadata.annotations[N["l"].DYNAMIC_SSHKEYS_USERS]=JSON.stringify(Array.from(new Set(o))),this.spec.template.metadata.annotations[N["l"].DYNAMIC_SSHKEYS_NAMES]=JSON.stringify(r))},getInitUserData:function(e){var t=this.getMatchQGA(e.osType),s=o.a.dump(t);return"#cloud-config\n".concat(s)},getUserData:function(e){try{var t=this.userScript?n["a"].parseDocument(this.userScript):n["a"].parseDocument({}),s=this.mergeSSHAuthorizedKeys(this.userScript);s.length>0?t.setIn(["ssh_authorized_keys"],s):n["a"].isCollection(t.getIn("ssh_authorized_keys"))&&t.deleteIn(["ssh_authorized_keys"]),t=e.installAgent?this.mergeQGA(R({userDataDoc:t},e)):this.deleteQGA(R({userDataDoc:t},e));var a=t.toString();if("{}\n"===a)return;return a}catch(i){return console.error("Error: Unable to parse yaml document",i),this.userScript}},updateSSHKey:function(e){this.$set(this,"sshKey",e)},updateCpuMemory:function(e,t){this.$set(this,"cpu",e),this.$set(this,"memory",t)},parseDisk:function(e,t){var s={name:e.name};return e.type===H?s.disk={bus:e.bus}:e.type===L&&(s.cdrom={bus:e.bus}),s.bootOrder=t+1,s},parseVolume:function(e,t){var s={name:e.name};return e.source===b["d"].CONTAINER?s.containerDisk={image:e.container}:e.source!==b["d"].IMAGE&&e.source!==b["d"].NEW&&e.source!==b["d"].ATTACH_VOLUME||(s.persistentVolumeClaim={claimName:t},e.hotpluggable&&(s.persistentVolumeClaim.hotpluggable=!0)),s},parseVolumeClaimTemplate:function(e,t){!String(e.size).includes("Gi")&&e.size&&(e.size="".concat(e.size,"Gi"));var s={metadata:{name:t},spec:{accessModes:[e.accessMode],resources:{requests:{storage:e.size}},volumeMode:e.volumeMode}};switch(e.source){case b["d"].NEW:s.spec.storageClassName=e.storageClassName||this.customDefaultStorageClass||this.defaultStorageClass;break;case b["d"].IMAGE:var a=this.images.find((function(t){return e.image===t.id}));a?(s.spec.storageClassName="longhorn-".concat(a.metadata.name),s.metadata.annotations=P({},N["l"].IMAGE_ID,a.id)):this.resource===E["a"].VM_VERSION&&(s.metadata.annotations=P({},N["l"].IMAGE_ID,""));break}return s},getSSHListValue:function(e){var t=this;return e.map((function(e){return t.getSSHValue(e)})).filter((function(e){return void 0!==e}))},parseInterface:function(e){var t={},s=e.type;return t[s]={},e.macAddress&&(t.macAddress=e.macAddress),t.model=e.model,t.name=e.name,t},parseNetwork:function(e){var t={name:e.name};return e.isPod?t.pod={}:t.multus={networkName:e.networkName},t},updateUserData:function(e){this.userScript=e},updateNetworkData:function(e){this.networkScript=e},mergeSSHAuthorizedKeys:function(e){try{var t,s=(null===(t=n["a"].parseDocument(e).get("ssh_authorized_keys"))||void 0===t?void 0:t.toJSON())||[],a=this.getSSHListValue(this.sshKey);return s.length?O(new Set([].concat(O(a),O(s)))):a}catch(i){return[]}},deleteYamlDocProp:function(e,t){try{var s,a,i=null===(s=e.getIn([]))||void 0===s?void 0:s.items[0],n=null===i||void 0===i?void 0:i.key,r=!(null===n||void 0===n||null===(a=n.commentBefore)||void 0===a||!a.includes("cloud-config")),o=n.source===t[t.length-1];n&&r&&o||e.deleteIn(t)}catch(l){}},mergeQGA:function(e){var t=this,s=e.osType,a=e.userDataDoc,i=this.getMatchQGA(s),r=a.toString(),o=n["a"].parse(r),l=(null===o||void 0===o?void 0:o.packages)||[],u=(null===o||void 0===o?void 0:o.runcmd)||[];if(a.setIn(["package_update"],!0),Array.isArray(l)?l.includes("qemu-guest-agent")||l.push("qemu-guest-agent"):l=I["a"].packages,Array.isArray(u)){var c=-1,d=u.find((function(e){return Array.isArray(e)&&e.join("-")===i.runcmd[0].join("-")})),v=u.find((function(e,a){return!(!Array.isArray(e)||e.join("-")!==t.getSimilarRuncmd(s).join("-"))&&(c=a,!0)}));v?u[c]=i.runcmd[0]:d||u.push(i.runcmd[0])}else u=i.runcmd;return l.length>0?a.setIn(["packages"],l):(a.setIn(["packages"],[]),this.deleteYamlDocProp(a,["packages"]),this.deleteYamlDocProp(a,["package_update"])),u.length>0?a.setIn(["runcmd"],u):this.deleteYamlDocProp(a,["runcmd"]),a},deleteQGA:function(e){var t,s,a=e.osType,i=e.userDataDoc,r=e.deletePackage,o=void 0!==r&&r,l=(null===(t=this.$store.getters["harvester/byId"](w["e"],this.userDataTemplateId))||void 0===t||null===(s=t.data)||void 0===s?void 0:s.cloudInit)||"",u=i.toString(),c=n["a"].parse(u),d=(null===c||void 0===c?void 0:c.packages)||[],v=(null===c||void 0===c?void 0:c.runcmd)||[];if(Array.isArray(d)&&o)for(var h=this.convertToJson(l),m=0;m<d.length;m++)"qemu-guest-agent"===d[m]&&(Array.isArray(null===h||void 0===h?void 0:h.packages)&&h.packages.includes("qemu-guest-agent")||d.splice(m,1));if(Array.isArray(v))for(var p=this.getMatchQGA(a),f=0;f<v.length;f++)Array.isArray(v[f])&&v[f].join("-")===p.runcmd[0].join("-")&&v.splice(f,1);return d.length>0?i.setIn(["packages"],d):(i.setIn(["packages"],[]),this.deleteYamlDocProp(i,["packages"]),this.deleteYamlDocProp(i,["package_update"])),v.length>0?i.setIn(["runcmd"],v):this.deleteYamlDocProp(i,["runcmd"]),i},generateSecretName:function(e){return e?"".concat(e,"-").concat(Object(g["p"])(5).toLowerCase()):void 0},getOwnerReferencesFromVM:function(e){var t,s=e.metadata.name,a=e.kind,i=this.resource===E["a"].VM?"kubevirt.io/v1":"harvesterhci.io/v1beta1",n=null===e||void 0===e||null===(t=e.metadata)||void 0===t?void 0:t.uid;return[{name:s,kind:a,uid:n,apiVersion:i}]},saveSecret:function(e){var t=this;return U(i.a.mark((function s(){var a,n;return i.a.wrap((function(s){while(1)switch(s.prev=s.next){case 0:if(null!==e&&void 0!==e&&e.spec&&t.secretName&&!t.isWindows){s.next=2;break}return s.abrupt("return",!0);case 2:if(a=t.getSecret(e.spec),n=t.getUserData({osType:t.osType,installAgent:t.installAgent}),a&&!t.needNewSecret){s.next=8;break}return s.next=7,t.$store.dispatch("harvester/create",{metadata:{name:t.secretName,namespace:t.value.metadata.namespace,labels:P({},N["l"].CLOUD_INIT,"harvester"),ownerReferences:t.getOwnerReferencesFromVM(e)},type:w["E"]});case 7:a=s.sent;case 8:if(s.prev=8,!a){s.next=14;break}return a.setData("userdata",n),a.setData("networkdata",t.networkScript),s.next=14,a.save();case 14:s.next=19;break;case 16:return s.prev=16,s.t0=s["catch"](8),s.abrupt("return",Promise.reject(s.t0));case 19:case"end":return s.stop()}}),s,null,[[8,16]])})))()},saveAccessCredentials:function(e){var t=this;return U(i.a.mark((function s(){var a,n,r,o,l,u,c,d,v,h,m;return i.a.wrap((function(s){while(1)switch(s.prev=s.next){case 0:if(null!==e&&void 0!==e&&e.spec){s.next=2;break}return s.abrupt("return",!0);case 2:a=[],n=M(t.accessCredentials),s.prev=4,n.s();case 6:if((r=n.n()).done){s.next=18;break}if(o=r.value,l=o.secretRef,l&&!t.needNewSecret){s.next=13;break}return s.next=12,t.$store.dispatch("harvester/create",{metadata:{name:o.secretName,namespace:e.metadata.namespace,labels:P({},N["l"].CLOUD_INIT,"harvester"),ownerReferences:t.getOwnerReferencesFromVM(e)},type:w["E"]});case 12:l=s.sent;case 13:if(o.source===b["a"].RESET_PWD&&l.setData(o.username,o.newPassword),o.source===b["a"].INJECT_SSH){u=M(o.sshkeys);try{for(d=function(){var e=c.value,s=(t.$store.getters["harvester/all"](E["a"].SSH)||[]).find((function(t){return t.id===e}));l.setData("".concat(s.metadata.namespace,"-").concat(s.metadata.name),s.spec.publicKey)},u.s();!(c=u.n()).done;)d()}catch(i){u.e(i)}finally{u.f()}}a.push(l);case 16:s.next=6;break;case 18:s.next=23;break;case 20:s.prev=20,s.t0=s["catch"](4),n.e(s.t0);case 23:return s.prev=23,n.f(),s.finish(23);case 26:s.prev=26,v=0,h=a;case 28:if(!(v<h.length)){s.next=35;break}return m=h[v],s.next=32,m.save();case 32:v++,s.next=28;break;case 35:s.next=40;break;case 37:return s.prev=37,s.t1=s["catch"](26),s.abrupt("return",Promise.reject(s.t1));case 40:case"end":return s.stop()}}),s,null,[[4,20,23,26],[26,37]])})))()},getAccessCredentialsValidation:function(){for(var e=[],t=0;t<this.accessCredentials.length;t++){var s=this.accessCredentials[t],a=s.source;if(a===b["a"].RESET_PWD){if(!s.username){var i=this.t("harvester.virtualMachine.input.username"),n=this.t("validation.required",{key:i});e.push(n)}if(!s.newPassword){var r=this.t("harvester.virtualMachine.input.password"),o=this.t("validation.required",{key:r});e.push(o)}if(s.newPassword&&s.newPassword.length<6){var l=this.t("harvester.virtualMachine.input.password"),u=this.t("validation.number.min",{key:l,val:"6"});e.push(u)}}else{if(!s.users||0===s.users.length){var c=this.t("harvester.virtualMachine.input.username"),d=this.t("validation.required",{key:c});e.push(d)}if(!s.sshkeys||0===s.sshkeys.length){var v=this.t("harvester.virtualMachine.input.sshKeyValue"),h=this.t("validation.required",{key:v});e.push(h)}}if(e.length>0)break}return e},getHasCreatedVolumes:function(e){var t=[];return e.template.spec.volumes&&e.template.spec.volumes.forEach((function(e){var s;null!==e&&void 0!==e&&null!==(s=e.persistentVolumeClaim)&&void 0!==s&&s.claimName&&t.push(e.persistentVolumeClaim.claimName)})),t},handlerUSBTablet:function(e){var t,s=this.isInstallUSBTablet(this.spec),a=(null===(t=this.spec.template.spec.domain.devices)||void 0===t?void 0:t.inputs)||[];if(e&&!s)a.length>0?a.push(I["b"][0]):Object.assign(this.spec.template.spec.domain.devices,{inputs:[I["b"][0]]});else if(!e){var i=a.findIndex((function(e){return u()(e,I["b"][0])}));s&&1===a.length?this.$delete(this.spec.template.spec.domain.devices,"inputs"):s&&(a.splice(i,1),this.$set(this.spec.template.spec.domain.devices,"inputs",a))}},setBootMethod:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{efi:!1,secureBoot:!1};e.efi&&e.secureBoot?(Object(p["set"])(this.spec.template.spec.domain,"features.smm.enabled",!0),Object(p["set"])(this.spec.template.spec.domain,"firmware.bootloader.efi.secureBoot",!0)):e.efi&&!e.secureBoot?(Object(p["set"])(this.spec.template.spec.domain,"features.smm.enabled",!1),Object(p["set"])(this.spec.template.spec.domain,"firmware.bootloader.efi.secureBoot",!1)):(this.$delete(this.spec.template.spec.domain,"firmware"),this.$delete(this.spec.template.spec.domain.features,"smm"))},deleteSSHFromUserData:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],s=this.getSSHFromUserData(this.userScript);t.map((function(t){var a=s.findIndex((function(s){return s===e.getSSHValue(t)}));a>=0&&s.splice(a,1)}));var a=this.convertToJson(this.userScript);a.ssh_authorized_keys=s,0===s.length&&delete a.ssh_authorized_keys,d()(a)?this.$set(this,"userScript",void 0):this.$set(this,"userScript",o.a.dump(a)),this.refreshYamlEditor()},refreshYamlEditor:function(){var e=this;this.$nextTick((function(){var t;null===(t=e.$refs.yamlEditor)||void 0===t||t.updateValue()}))},toggleAdvanced:function(){this.showAdvanced=!this.showAdvanced},updateAgent:function(e){e||(this.deletePackage=!0)},updateDataTemplateId:function(e,t){var s=this;if("user"===e){var a=this.installAgent;this.userDataTemplateId=t,this.$nextTick((function(){a&&(s.installAgent=a)}))}},updateReserved:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.memory;this.$set(this,"reservedMemory",t)}},watch:{diskRows:{handler:function(e,t){if(Array.isArray(e)){var s,a,i=null===(s=e[0])||void 0===s?void 0:s.image,n=this.images.find((function(e){return i===e.id})),r=null===n||void 0===n?void 0:n.imageOSType,o=null===(a=t[0])||void 0===a?void 0:a.image;this.isCreate&&o===i&&i&&(this.osType=r)}}},secretRef:{handler:function(e){var t,s;e&&this.resource!==E["a"].BACKUP&&(this.userScript=null===e||void 0===e||null===(t=e.decodedData)||void 0===t?void 0:t.userdata,this.networkScript=null===e||void 0===e||null===(s=e.decodedData)||void 0===s?void 0:s.networkdata,this.secretName=null===e||void 0===e?void 0:e.metadata.name,this.refreshYamlEditor())},immediate:!0,deep:!0},isWindows:function(e){e&&(this.$set(this,"sshKey",[]),this.$set(this,"userScript",void 0),this.$set(this,"installAgent",!1))},installUSBTablet:function(e){this.handlerUSBTablet(e)},efiEnabled:function(e){this.setBootMethod({efi:e,secureBoot:this.secureBoot})},secureBoot:function(e){this.setBootMethod({efi:this.efiEnabled,secureBoot:e})},installAgent:{handler:function(e){if(this.deleteAgent){var t=this.getUserData({installAgent:e,osType:this.osType,deletePackage:this.deletePackage});this.$set(this,"userScript",t),this.refreshYamlEditor()}this.deleteAgent=!0,this.deletePackage=!1}},osType:function(e){var t=this.getUserData({installAgent:this.installAgent,osType:e});this.$set(this,"userScript",t),this.refreshYamlEditor()},userScript:function(e,t){var s=this.hasInstallAgent(e,this.osType,this.installAgent);s!==this.installAgent&&(this.deleteAgent=!1,this.installAgent=s)},sshKey:function(e,t){var s=h()(t,e);s.length&&this.isEdit&&this.deleteSSHFromUserData(s)}}}}}]);
//# sourceMappingURL=harvester-v1.0.3.umd.min.detail~edit~formatters.js.map