(("undefined"!==typeof self?self:this)["webpackJsonpharvester_v1_2_1"]=("undefined"!==typeof self?self:this)["webpackJsonpharvester_v1_2_1"]||[]).push([[0],{"2c0b":function(e,t,s){"use strict";var i=function(){var e=this,t=e._self._c;return t("div",[e.arbitrary?t("div",[e.value?t("BadgeState",{attrs:{color:e.stateBackground,label:e.stateDisplay}}):e._e()],1):t("BadgeState",{attrs:{value:e.row}})],1)},a=[],o=s("57ab"),n=s("35ef"),r={components:{BadgeState:o["a"]},props:{value:{type:String,default:""},row:{type:Object,required:!0},col:{type:Object,default:()=>{}},arbitrary:{type:Boolean,default:!1}},data(){return{stateDisplay:"",stateBackground:""}},watch:{value:{handler(){if(this.arbitrary){const e=Object(n["c"])(this.value);this.stateDisplay=Object(n["e"])(this.value),this.stateBackground=e.replace("text-","bg-")}},immediate:!0}}},l=r,d=s("d802"),c=Object(d["a"])(l,i,a,!1,null,null,null);t["a"]=c.exports},"4b06":function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"b",(function(){return v}));var i=s("e3b5"),a=s("7838"),o=s.n(a),n=s("9e74"),r=s.n(n),l=s("1832"),d=s("56a4"),c=s("90cd"),u=s("873f"),h=s("6834");const m={package_update:!0,packages:["qemu-guest-agent"],runcmd:[["systemctl","enable","--now","qemu-guest-agent.service"]]},p={default:"qemu-guest-agent.service"},v=[{bus:"usb",name:"tablet",type:"tablet"}],g={EXISTING_ALL:"EXISTING_ALL",EXISTING_ONLY_ANNOTATION:"EXISTING_ANNOTATION",EXISTING_ONLY_CLOUD:"EXISTING_CLOUD"};t["c"]={methods:{hasCloudConfigComment(e){var t,s,a;const o=e?i["a"].parseDocument(e):i["a"].parseDocument({}),n=(null===o||void 0===o||null===(t=o.contents)||void 0===t?void 0:t.items)||[];let r=!1;return("cloud-config"===(null===o||void 0===o?void 0:o.comment)||null!==o&&void 0!==o&&null!==(s=o.comment)&&void 0!==s&&s.includes("cloud-config\n"))&&(r=!0),("cloud-config"===(null===o||void 0===o?void 0:o.commentBefore)||null!==o&&void 0!==o&&null!==(a=o.commentBefore)&&void 0!==a&&a.includes("cloud-config\n"))&&(r=!0),n.map(e=>{var t;const s=e.key;("cloud-config"===(null===s||void 0===s?void 0:s.commentBefore)||null!==s&&void 0!==s&&null!==(t=s.commentBefore)&&void 0!==t&&t.includes("cloud-config\n"))&&(r=!0)}),r},getSSHValue(e){var t,s;const i=this.$store.getters["currentProduct"].inStore,a=this.$store.getters[i+"/all"](c["b"].SSH)||[];return(null===(t=a.find(t=>t.id===e))||void 0===t||null===(s=t.spec)||void 0===s?void 0:s.publicKey)||void 0},getOsType(e){var t,s;return null===(t=e.metadata)||void 0===t||null===(s=t.labels)||void 0===s?void 0:s[u["a"].OS]},getMatchQGA(e){const t=Object(l["e"])(m);let s=!1;return h["b"].forEach(t=>{t.match&&(s=t.match.find(t=>t===e))}),t.runcmd[0][3]=s?p[e]:p["default"],t},getSimilarRuncmd(e){const t=Object(l["e"])(m);return t.runcmd[0][3]="openSUSE"===e?p["default"]:p["suse"],t.runcmd[0]},hasInstallAgent(e,t,s){var i,a,n,r;let l={};const d=this.getMatchQGA(t);try{l=o.a.load(e)||{}}catch(c){return new Error("Function(hasInstallAgent) error"),s}return(null===(i=l)||void 0===i||null===(a=i.packages)||void 0===a?void 0:a.includes("qemu-guest-agent"))&&!(null===(n=l)||void 0===n||null===(r=n.runcmd)||void 0===r||!r.find(e=>Array.isArray(e)&&e.join("-")===d.runcmd[0].join("-")))},isInstallUSBTablet(e){var t,s,i,a;const o=null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(i=s.domain)||void 0===i||null===(a=i.devices)||void 0===a?void 0:a.inputs;return!!Array.isArray(o)&&!!o.find(e=>r()(e,v[0]))},isEfiEnabled(e){var t,s,i,a,o;return!(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(i=s.domain)||void 0===i||null===(a=i.firmware)||void 0===a||null===(o=a.bootloader)||void 0===o||!o.efi)},isTpmEnabled(e){var t,s,i,a;return!(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(i=s.domain)||void 0===i||null===(a=i.devices)||void 0===a||!a.tpm)},isSecureBoot(e){var t,s,i,a,o,n;return!(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(i=s.domain)||void 0===i||null===(a=i.firmware)||void 0===a||null===(o=a.bootloader)||void 0===o||null===(n=o.efi)||void 0===n||!n.secureBoot)},getCloudInitNoCloud(e){var t,s,i,a,o,n;const r=this.getSecret(e);let l=null===r||void 0===r||null===(t=r.decodedData)||void 0===t?void 0:t.userdata,d=null===r||void 0===r||null===(s=r.decodedData)||void 0===s?void 0:s.networkdata;const c=(null===e||void 0===e||null===(i=e.template)||void 0===i||null===(a=i.spec)||void 0===a||null===(o=a.volumes)||void 0===o||null===(n=o.find(e=>"cloudinitdisk"===e.name))||void 0===n?void 0:n.cloudInitNoCloud)||{};return null!==c&&void 0!==c&&c.userData&&(l=c.userData,this.saveUserDataAsClearText=!0),null!==c&&void 0!==c&&c.networkData&&(d=c.networkData,this.saveNetworkDataAsClearText=!0),{userData:l,networkData:d}},getSecret(e){var t,s,i,a,o,n;const r=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s||null===(i=s.volumes)||void 0===i||null===(a=i.find(e=>"cloudinitdisk"===e.name))||void 0===a?void 0:a.cloudInitNoCloud)||{},l=this.$store.getters["currentProduct"].inStore,c=this.$store.getters[l+"/all"](d["J"])||[],u=(null===r||void 0===r||null===(o=r.secretRef)||void 0===o?void 0:o.name)||(null===r||void 0===r||null===(n=r.networkDataSecretRef)||void 0===n?void 0:n.name),h=c.find(e=>e.metadata.name===u);return h},getAccessCredentials(e){var t,s,i,a;const o=this.$store.getters["currentProduct"].inStore,n=this.$store.getters[o+"/all"](d["J"])||[],r=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.spec)||void 0===s?void 0:s.accessCredentials)||[],l=JSON.parse((null===(i=e.template.metadata)||void 0===i||null===(a=i.annotations)||void 0===a?void 0:a[u["a"].DYNAMIC_SSHKEYS_NAMES])||"[]");return r.map(e=>{var t,s,i;const a=e.userPassword?"userPassword":"sshPublicKey",o=null===(t=e[a])||void 0===t||null===(s=t.source)||void 0===s||null===(i=s.secret)||void 0===i?void 0:i.secretName,r=n.find(e=>e.metadata.name===o),d={source:a,username:"",newPassword:"",users:[],sshkeys:[],secretName:o,secretRef:r};if(r)if("userPassword"===a){const e=Object.keys(null===r||void 0===r?void 0:r.data)[0],t=r.decodedData[e];d.username=e,d.newPassword=t}else{const t=e[a].propagationMethod.qemuGuestAgent.users,s=null===l||void 0===l?void 0:l[o];d.users=t,d.sshkeys=s}else d.secretRef=void 0;return d})},getVolumeClaimTemplates(e){let t=[];try{t=JSON.parse(e.metadata.annotations[u["a"].VOLUME_CLAIM_TEMPLATE])}catch(s){new Error("Function: getVolumeClaimTemplates, "+s)}return t},getRootImageId(e){var t,s,i;const a=this.getVolumeClaimTemplates(e);return(null===(t=a[0])||void 0===t||null===(s=t.metadata)||void 0===s||null===(i=s.annotations)||void 0===i?void 0:i[u["a"].IMAGE_ID])||""},getSSHFromAnnotation(e){var t,s,i;const a=(null===e||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.metadata)||void 0===s||null===(i=s.annotations)||void 0===i?void 0:i[u["a"].SSH_NAMES])||"[]";return JSON.parse(a)},convertToJson(e=""){let t={};try{t=o.a.load(e)}catch(s){new Error("Function(convertToJson) error")}return t},getSSHFromUserData(e){var t;return(null===(t=this.convertToJson(e))||void 0===t?void 0:t.ssh_authorized_keys)||[]},compareSSHValue(e="",t=""){const s=/(\r\n\t|\n|\r\t)|(\s*)/gm;return e.replace(s,"")===t.replace(s,"")},mergeAllSSHs(e){const t=this.getSSHFromAnnotation(e),{userScript:s}=this.getCloudInitNoCloud(e);if(!(null!==t&&void 0!==t&&t.length)<0&&!s)return[];let i=[];const a=this.$store.getters["currentProduct"].inStore,o=this.$store.getters[a+"/all"](c["b"].SSH)||[];i=(t||[]).map(e=>{const t=o.find(t=>t.id===e);return t?{id:t.id,data:t,type:g.EXISTING_ALL}:{id:e,data:e,type:g.EXISTING_ONLY_ANNOTATION}});const n=this.getSSHFromUserData(s);return n.map(e=>{const t=o.find(t=>{var s;return this.compareSSHValue(e,null===(s=t.spec)||void 0===s?void 0:s.publicKey)});t&&!i.find(e=>e.id===t.id)?i.push({id:t.id,data:t,type:g.EXISTING_ALL}):t||i.push({id:"Unknown",data:e,type:g.EXISTING_ONLY_CLOUD})}),i}}}},6834:function(e,t,s){"use strict";s.d(t,"a",(function(){return T})),s.d(t,"b",(function(){return M}));var i=s("e3b5"),a=s("7838"),o=s.n(a),n=s("9e74"),r=s.n(n),l=s("330a"),d=s.n(l),c=s("94a3"),u=s.n(c),h=s("7592"),m=s("1832"),p=s("b837"),v=s("06f6"),g=s("8672"),f=s("67ab"),S=s("7c47"),y=s("d6a6"),b=s("56a4"),A=s("90cd"),N=s("fa85"),E=s("b0bd"),k=s("873f"),w=s("4b06"),I=s("e411");const T="management Network",M=[{label:"Windows",value:"windows"},{label:"Linux",value:"linux"},{label:"SUSE Linux Enterprise",value:"SLEs"},{label:"Debian",value:"debian"},{label:"Fedora",value:"fedora"},{label:"Gentoo",value:"gentoo"},{label:"Oracle",value:"oracle"},{label:"Red Hat",value:"redhat"},{label:"openSUSE",value:"openSUSE"},{label:"Ubuntu",value:"ubuntu"},{label:"Other Linux",match:["centos"],value:"otherLinux"}],C="cd-rom",$="disk";t["c"]={mixins:[w["c"]],props:{value:{type:Object,required:!0},resource:{type:String,default:""}},async fetch(){var e,t;const s=this.$store.getters["currentProduct"].inStore,i={pvs:this.$store.dispatch(s+"/findAll",{type:b["D"]}),pvcs:this.$store.dispatch(s+"/findAll",{type:b["E"]}),storageClasses:this.$store.dispatch(s+"/findAll",{type:b["O"]}),sshs:this.$store.dispatch(s+"/findAll",{type:A["b"].SSH}),settings:this.$store.dispatch(s+"/findAll",{type:A["b"].SETTING}),images:this.$store.dispatch(s+"/findAll",{type:A["b"].IMAGE}),versions:this.$store.dispatch(s+"/findAll",{type:A["b"].VM_VERSION}),templates:this.$store.dispatch(s+"/findAll",{type:A["b"].VM_TEMPLATE}),networkAttachment:this.$store.dispatch(s+"/findAll",{type:b["x"]}),vmis:this.$store.dispatch(s+"/findAll",{type:A["b"].VMI}),vmims:this.$store.dispatch(s+"/findAll",{type:A["b"].VMIM}),vms:this.$store.dispatch(s+"/findAll",{type:A["b"].VM}),secrets:this.$store.dispatch(s+"/findAll",{type:b["J"]}),addons:this.$store.dispatch(s+"/findAll",{type:A["b"].ADD_ONS})};this.$store.getters[s+"/schemaFor"](b["z"])&&(i.nodes=this.$store.dispatch(s+"/findAll",{type:b["z"]})),this.$store.getters[s+"/schemaFor"](A["b"].CLUSTER_NETWORK)&&(i.clusterNetworks=this.$store.dispatch(s+"/findAll",{type:A["b"].CLUSTER_NETWORK})),this.$store.getters[s+"/schemaFor"](A["b"].VLAN_CONFIG)&&(i.clusterNetworks=this.$store.dispatch(s+"/findAll",{type:A["b"].VLAN_CONFIG})),this.$store.getters[s+"/schemaFor"](b["s"].VOLUMES)&&(i.longhornVolumes=this.$store.dispatch(s+"/findAll",{type:b["s"].VOLUMES}));const a=await Object(p["a"])(i),o=this.$store.getters[s+"/schemaFor"](A["b"].PCI_DEVICE);this.enabledPCI=!0===(null===(e=a.addons.find(e=>"pcidevices-controller"===e.name))||void 0===e||null===(t=e.spec)||void 0===t?void 0:t.enabled)&&o},data(){const e=this.realMode===y["x"];return{OS:M,isClone:e,spec:null,osType:"linux",sshKey:[],runStrategy:"RerunOnFailure",installAgent:!0,hasCreateVolumes:[],installUSBTablet:!0,networkScript:"",userScript:"",imageId:"",diskRows:[],networkRows:[],machineType:"",secretName:"",secretRef:null,showAdvanced:!1,deleteAgent:!0,memory:null,cpu:"",reservedMemory:null,accessCredentials:[],efiEnabled:!1,tpmEnabled:!1,secureBoot:!1,userDataTemplateId:"",saveUserDataAsClearText:!1,saveNetworkDataAsClearText:!1,enabledPCI:!1,immutableMode:this.realMode===y["z"]?y["z"]:y["I"],terminationGracePeriodSeconds:""}},computed:{inStore(){return this.$store.getters["currentProduct"].inStore},images(){return this.$store.getters[this.inStore+"/all"](A["b"].IMAGE)},versions(){return this.$store.getters[this.inStore+"/all"](A["b"].VM_VERSION)},templates(){return this.$store.getters[this.inStore+"/all"](A["b"].VM_TEMPLATE)},pvcs(){return this.$store.getters[this.inStore+"/all"](b["E"])},secrets(){return this.$store.getters[this.inStore+"/all"](b["J"])},filteredNamespaces(){return this.$store.getters["harvester/all"](b["w"]).filter(e=>!e.isSystem)},nodes(){return this.$store.getters["harvester/all"](b["z"])},nodesIdOptions(){const e=this.$store.getters[this.inStore+"/all"](b["z"]),t=this.networkRows.map(e=>e.networkName),s=this.$store.getters[this.inStore+"/all"](b["x"]),i=t.map(e=>s.find(t=>t.id===e)).filter(e=>null===e||void 0===e?void 0:e.id),a=Object(I["m"])(i.map(e=>{var t;return null===(t=e.clusterNetworkResource)||void 0===t?void 0:t.id}));return e.filter(e=>!e.isUnSchedulable).map(e=>{const t=[];let s=!0;return a.length>0&&a.map(e=>{t.push("network.harvesterhci.io/"+e)}),t.map(t=>{var i,a;"true"!==(null===(i=e.metadata)||void 0===i||null===(a=i.labels)||void 0===a?void 0:a[t])&&(s=!1)}),{label:s?e.nameDisplay:`${e.nameDisplay} (${this.t("harvester.virtualMachine.scheduling.networkNotSupport")})`,value:e.id,disabled:!s}})},defaultStorageClass(){var e;const t=this.$store.getters[this.inStore+"/all"](b["O"]).find(e=>e.isDefault);return(null===t||void 0===t||null===(e=t.metadata)||void 0===e?void 0:e.name)||"longhorn"},storageClassSetting(){try{var e;const t=null===(e=this.$store.getters[this.inStore+"/all"](A["b"].SETTING).find(e=>e.id===N["b"].DEFAULT_STORAGE_CLASS))||void 0===e?void 0:e.value;return JSON.parse(t)}catch(t){return{}}},customVolumeMode(){return this.storageClassSetting.volumeMode||"Block"},customAccessMode(){return this.storageClassSetting.accessModes||"ReadWriteMany"},isWindows(){return"windows"===this.osType},needNewSecret(){return this.resource===A["b"].VM_VERSION||this.isCreate},defaultTerminationSetting(){const e=this.$store.getters[this.inStore+"/all"](A["b"].SETTING).find(e=>e.id===N["b"].VM_TERMINATION_PERIOD)||{};return Number((null===e||void 0===e?void 0:e.value)||(null===e||void 0===e?void 0:e.default))},affinityLabels(){return{namespaceInputLabel:this.t("harvesterManager.affinity.namespaces.label"),namespaceSelectionLabels:[this.t("harvesterManager.affinity.thisPodNamespace"),this.t("workload.scheduling.affinity.allNamespaces"),this.t("harvesterManager.affinity.matchExpressions.inNamespaces")],addLabel:this.t("harvesterManager.affinity.addLabel"),topologyKeyPlaceholder:this.t("harvesterManager.affinity.topologyKey.placeholder")}}},async created(){await this.$store.dispatch(this.inStore+"/findAll",{type:b["J"]}),this.getInitConfig({value:this.value,init:this.isCreate})},methods:{getInitConfig(e){var t,s,i,a,o,n,r,l;const{value:d,existUserData:c,fromTemplate:u=!1,init:h=!1}=e,m=this.resource===A["b"].VM?d:this.resource===A["b"].BACKUP?null===(t=this.value.status)||void 0===t?void 0:t.source:d.spec.vm,p=null===m||void 0===m?void 0:m.spec;if(!p)return;const v=p.template.spec.domain.resources;null!==v&&void 0!==v&&v.limits&&(null===v||void 0===v||!v.limits||null!==v&&void 0!==v&&null!==(s=v.limits)&&void 0!==s&&s.memory||null===(null===v||void 0===v||null===(i=v.limits)||void 0===i?void 0:i.memory))||(p.template.spec.domain.resources={...p.template.spec.domain.resources,limits:{...p.template.spec.domain.resources.limits,memory:p.template.spec.domain.resources.requests.memory}});const f=p.runStrategy||"RerunOnFailure",S=d.machineType,y=null===(a=p.template.spec.domain)||void 0===a||null===(o=a.cpu)||void 0===o?void 0:o.cores,b=p.template.spec.domain.resources.limits.memory,N=null===(n=m.metadata)||void 0===n||null===(r=n.annotations)||void 0===r?void 0:r[k["a"].VM_RESERVED_MEMORY],E=(null===(l=p.template.spec)||void 0===l?void 0:l.terminationGracePeriodSeconds)||this.defaultTerminationSetting,w=this.getSSHFromAnnotation(p)||[],I=this.getRootImageId(m)||"",T=this.getDiskRows(m),M=this.getNetworkRows(m,{fromTemplate:u,init:h}),C=this.getHasCreatedVolumes(p)||[];let{userData:$,networkData:D}=this.getCloudInitNoCloud(p);if(this.resource===A["b"].BACKUP){var O;const e=null===(O=this.value.status)||void 0===O?void 0:O.secretBackups;if(e){var _,V,R,P;const t=(null===(_=e[0])||void 0===_||null===(V=_.data)||void 0===V?void 0:V.networkdata)||"",s=(null===(R=e[0])||void 0===R||null===(P=R.data)||void 0===P?void 0:P.userdata)||"";$=Object(g["a"])(s),D=Object(g["a"])(t)}}const U=this.getOsType(m)||"linux";$=!this.isCreate||c||this.isClone?$:this.getInitUserData({osType:U});const L=this.isInstallUSBTablet(p),G=this.hasInstallAgent($,U,!0),B=this.isEfiEnabled(p),j=this.isTpmEnabled(p),H=this.isSecureBoot(p),x=this.getSecret(p),K=this.getAccessCredentials(p);Object.prototype.hasOwnProperty.call(p,"running")&&(delete p.running,p.runStrategy="RerunOnFailure"),this.$set(this,"spec",p),this.$set(this,"runStrategy",f),this.$set(this,"secretRef",x),this.$set(this,"accessCredentials",K),this.$set(this,"userScript",$),this.$set(this,"networkScript",D),this.$set(this,"sshKey",w),this.$set(this,"osType",U),this.$set(this,"installAgent",G),this.$set(this,"cpu",y),this.$set(this,"memory",b),this.$set(this,"reservedMemory",N),this.$set(this,"machineType",S),this.$set(this,"terminationGracePeriodSeconds",E),this.$set(this,"installUSBTablet",L),this.$set(this,"efiEnabled",B),this.$set(this,"tpmEnabled",j),this.$set(this,"secureBoot",H),this.$set(this,"hasCreateVolumes",C),this.$set(this,"networkRows",M),this.$set(this,"imageId",I),this.$set(this,"diskRows",T),this.refreshYamlEditor()},getDiskRows(e){const t=e.metadata.namespace,s=e.spec.template.spec.volumes||[],i=e.spec.template.spec.domain.devices.disks||[],a=this.getVolumeClaimTemplates(e);let o=[];return 0===i.length?o.push({id:Object(v["p"])(5),source:S["f"].IMAGE,name:"disk-0",accessMode:"ReadWriteMany",bus:"virtio",volumeName:"",size:"10Gi",type:$,storageClassName:"",image:this.imageId,volumeMode:"Block"}):o=i.map((e,i)=>{var o,n,r,l,d,c,u;const h=s.find(t=>t.name===e.name);let m="",p="",g="",y="",A="",N="",E="",w="",I="",T=!1,M=null;const D=null!==e&&void 0!==e&&e.cdrom?C:null!==e&&void 0!==e&&e.disk?$:"";if(null!==h&&void 0!==h&&h.containerDisk&&(g=S["f"].CONTAINER,A=h.containerDisk.image),h.persistentVolumeClaim&&null!==(o=h.persistentVolumeClaim)&&void 0!==o&&o.claimName){N=h.persistentVolumeClaim.claimName;const e=a.find(e=>e.metadata.name===N);if(y=N,e){var O,_,V,R,P,U,L;if(void 0!==(null===(O=e.metadata)||void 0===O||null===(_=O.annotations)||void 0===_?void 0:_[k["a"].IMAGE_ID]))p=null===(U=e.metadata)||void 0===U||null===(L=U.annotations)||void 0===L?void 0:L[k["a"].IMAGE_ID],g=S["f"].IMAGE;else g=S["f"].NEW;const t=(null===e||void 0===e?void 0:e.spec)||{};w=null===t||void 0===t?void 0:t.volumeMode,E=null===t||void 0===t||null===(V=t.accessModes)||void 0===V?void 0:V[0],m=(null===t||void 0===t||null===(R=t.resources)||void 0===R||null===(P=R.requests)||void 0===P?void 0:P.storage)||"10Gi",I=null===t||void 0===t?void 0:t.storageClassName,M=null===t||void 0===t?void 0:t.dataSource}else{var G,B,j,H,x,K,F,J;const e=this.$store.getters["harvester/all"](b["E"]),s=e.find(e=>{var s;return e.id===`${t}/${null===h||void 0===h||null===(s=h.persistentVolumeClaim)||void 0===s?void 0:s.claimName}`});g=S["f"].ATTACH_VOLUME,E=(null===s||void 0===s||null===(G=s.spec)||void 0===G||null===(B=G.accessModes)||void 0===B?void 0:B[0])||"ReadWriteMany",m=(null===s||void 0===s||null===(j=s.spec)||void 0===j||null===(H=j.resources)||void 0===H||null===(x=H.requests)||void 0===x?void 0:x.storage)||"10Gi",I=null===s||void 0===s||null===(K=s.spec)||void 0===K?void 0:K.storageClassName,w=(null===s||void 0===s||null===(F=s.spec)||void 0===F?void 0:F.volumeMode)||"Block",N=(null===s||void 0===s||null===(J=s.metadata)||void 0===J?void 0:J.name)||""}T=h.persistentVolumeClaim.hotpluggable||!1}const Y=(null===e||void 0===e||null===(n=e.disk)||void 0===n?void 0:n.bus)||(null===e||void 0===e||null===(r=e.cdrom)||void 0===r?void 0:r.bus),q=null!==e&&void 0!==e&&e.bootOrder?null===e||void 0===e?void 0:e.bootOrder:i,z=Object(f["f"])(m),W=Object(f["e"])(z,{increment:1024,addSuffix:!1,maxExponent:3,minExponent:3}),X=null===(l=this.pvcs.find(e=>e.id===`${this.value.metadata.namespace}/${N}`))||void 0===l||null===(d=l.relatedPV)||void 0===d||null===(c=d.metadata)||void 0===c||null===(u=c.annotations)||void 0===u?void 0:u[k["a"].VOLUME_ERROR];return{id:Object(v["p"])(5),bootOrder:q,source:g,name:e.name,realName:y,bus:Y,volumeName:N,container:A,accessMode:E,size:W+"Gi",volumeMode:w||this.customVolumeMode,image:p,type:D,storageClassName:I,hotpluggable:T,volumeStatus:X,dataSource:M,namespace:t}}),o=Object(h["b"])(o,"bootOrder"),o.filter(e=>"cloudinitdisk"!==e.name)},getNetworkRows(e,t){const{fromTemplate:s=!1,init:i=!1}=t,a=e.spec.template.spec.networks||[],o=e.spec.template.spec.domain.devices.interfaces||[],n=o.map((e,t)=>{var o;const n=a.find(t=>e.name===t.name),r=e.sriov?"sriov":e.bridge?"bridge":"masquerade",l=!!n.pod;return{...e,index:t,type:r,isPod:l,newCreateId:!(!s&&!i)&&Object(v["p"])(10),model:e.model,networkName:l?T:null===n||void 0===n||null===(o=n.multus)||void 0===o?void 0:o.networkName}});return n},parseVM(){this.userData=this.getUserData({osType:this.osType,installAgent:this.installAgent}),this.parseOther(),this.parseAccessCredentials(),this.parseNetworkRows(this.networkRows),this.parseDiskRows(this.diskRows)},parseOther(){this.spec.template.spec.domain.machine?this.$set(this.spec.template.spec.domain.machine,"type",this.machineType):this.$set(this.spec.template.spec.domain,"machine",{type:this.machineType}),this.spec.template.spec.domain.cpu.cores=this.cpu,this.spec.template.spec.domain.resources.limits.cpu=this.cpu?this.cpu.toString():this.cpu,this.spec.template.spec.domain.resources.limits.memory=this.memory,this.spec.template.spec.terminationGracePeriodSeconds=this.terminationGracePeriodSeconds;const e=this.resource===A["b"].VM?this.value:this.value.spec.vm;this.reservedMemory?e.metadata.annotations[k["a"].VM_RESERVED_MEMORY]=this.reservedMemory:delete e.metadata.annotations[k["a"].VM_RESERVED_MEMORY]},parseDiskRows(e){var t,s,i,a,o,n,r,l,d,c,u,h,m,p,g,f;const y=[],b=[],N=[],E=[];if(e.forEach((e,t)=>{var s;const i=(null===(s=this.value.metadata)||void 0===s?void 0:s.name)||"";let a="";a=e.source===S["f"].ATTACH_VOLUME?e.volumeName:this.isClone||!this.hasCreateVolumes.includes(e.realName)?`${i}-${e.name}-${Object(v["p"])(5).toLowerCase()}`:e.realName;const o=this.parseDisk(e,t),n=this.parseVolume(e,a),r=this.parseVolumeClaimTemplate(e,a);y.push(o),b.push(n),N.push(a),e.source!==S["f"].CONTAINER&&E.push(r)}),this.secretName&&!this.needNewSecret||(this.secretName=this.generateSecretName(this.secretNamePrefix)),!y.find(e=>"cloudinitdisk"===e.name)&&(this.userData||this.networkData)&&!this.isWindows){y.push({name:"cloudinitdisk",disk:{bus:"virtio"}});const e=this.getUserData({osType:this.osType,installAgent:this.installAgent}),t={name:"cloudinitdisk",cloudInitNoCloud:{}};this.saveUserDataAsClearText?t.cloudInitNoCloud.userData=e:t.cloudInitNoCloud.secretRef={name:this.secretName},this.saveNetworkDataAsClearText?t.cloudInitNoCloud.networkData=this.networkScript:t.cloudInitNoCloud.networkDataSecretRef={name:this.secretName},b.push(t)}let w={...this.spec,runStrategy:this.runStrategy,template:{...this.spec.template,metadata:{...null===(t=this.spec)||void 0===t||null===(s=t.template)||void 0===s?void 0:s.metadata,annotations:{...null===(i=this.spec)||void 0===i||null===(a=i.template)||void 0===a||null===(o=a.metadata)||void 0===o?void 0:o.annotations,[k["a"].SSH_NAMES]:JSON.stringify(this.sshKey)},labels:{...null===(n=this.spec)||void 0===n||null===(r=n.template)||void 0===r||null===(l=r.metadata)||void 0===l?void 0:l.labels,[k["a"].VM_NAME]:null===(d=this.value)||void 0===d||null===(c=d.metadata)||void 0===c?void 0:c.name}},spec:{...null===(u=this.spec.template)||void 0===u?void 0:u.spec,domain:{...null===(h=this.spec.template)||void 0===h||null===(m=h.spec)||void 0===m?void 0:m.domain,devices:{...null===(p=this.spec.template)||void 0===p||null===(g=p.spec)||void 0===g||null===(f=g.domain)||void 0===f?void 0:f.devices,disks:y}},volumes:b}}};0===b.length&&delete w.template.spec.volumes,this.resource===A["b"].VM?(this.isSingle||(w=this.multiVMScheduler(w)),this.$set(this.value.metadata,"annotations",{...this.value.metadata.annotations,[k["a"].VOLUME_CLAIM_TEMPLATE]:JSON.stringify(E),[k["a"].NETWORK_IPS]:JSON.stringify(this.value.networkIps)}),this.$set(this.value.metadata,"labels",{...this.value.metadata.labels,[k["a"].CREATOR]:"harvester",[k["a"].OS]:this.osType}),this.$set(this.value,"spec",w),this.$set(this,"spec",w)):this.resource===A["b"].VM_VERSION&&(this.$set(this.value.spec.vm,"spec",w),this.$set(this.value.spec.vm.metadata,"annotations",{...this.value.spec.vm.metadata.annotations,[k["a"].VOLUME_CLAIM_TEMPLATE]:JSON.stringify(E)}),this.$set(this.value.spec.vm.metadata,"labels",{...this.value.spec.vm.metadata.labels,[k["a"].OS]:this.osType}),this.$set(this,"spec",w))},removeTrailingHyphen(e){while(e.endsWith("-"))e=e.slice(0,-1);return e},multiVMScheduler(e){var t,s,i,a,o;const n=this.removeTrailingHyphen(this.namePrefix);e.template.metadata.labels[k["a"].VM_NAME_PREFIX]=n;const r={weight:1,podAffinityTerm:{topologyKey:E["m"],labelSelector:{matchLabels:{[k["a"].VM_NAME_PREFIX]:n}}}};return{...e,template:{...e.template,spec:{...e.template.spec,affinity:{...e.template.spec.affinity,podAntiAffinity:{...null===(t=e.template.spec)||void 0===t||null===(s=t.affinity)||void 0===s?void 0:s.podAntiAffinity,preferredDuringSchedulingIgnoredDuringExecution:[...(null===(i=e.template.spec)||void 0===i||null===(a=i.affinity)||void 0===a||null===(o=a.podAntiAffinity)||void 0===o?void 0:o.preferredDuringSchedulingIgnoredDuringExecution)||[],r]}}}}}},parseNetworkRows(e){const t=[],s=[];e.forEach(e=>{const i=this.parseNetwork(e),a=this.parseInterface(e);t.push(i),s.push(a)});const i={...this.spec.template.spec,domain:{...this.spec.template.spec.domain,devices:{...this.spec.template.spec.domain.devices,interfaces:s}},networks:t};this.$set(this.spec.template,"spec",i)},parseAccessCredentials(){var e,t,s,i;const a=[],o={},n=JSON.parse((null===(e=this.spec)||void 0===e||null===(t=e.template)||void 0===t||null===(s=t.metadata)||void 0===s||null===(i=s.annotations)||void 0===i?void 0:i[k["a"].DYNAMIC_SSHKEYS_USERS])||"[]");for(const r of this.accessCredentials)this.needNewSecret&&(r.secretName=this.generateSecretName(this.secretNamePrefix)),r.source===S["a"].RESET_PWD&&(n.push(r.username),a.push({userPassword:{source:{secret:{secretName:r.secretName}},propagationMethod:{qemuGuestAgent:{}}}})),r.source===S["a"].INJECT_SSH&&(n.push(...r.users),o[r.secretName]=r.sshkeys,a.push({sshPublicKey:{source:{secret:{secretName:r.secretName}},propagationMethod:{qemuGuestAgent:{users:r.users}}}}));0===a.length&&this.spec.template.spec.accessCredentials?delete this.spec.template.spec.accessCredentials:this.spec.template.spec.accessCredentials=a,0!==n.length&&(this.spec.template.metadata.annotations[k["a"].DYNAMIC_SSHKEYS_USERS]=JSON.stringify(Array.from(new Set(n))),this.spec.template.metadata.annotations[k["a"].DYNAMIC_SSHKEYS_NAMES]=JSON.stringify(o))},getInitUserData(e){const t=this.getMatchQGA(e.osType),s=o.a.dump(t);return"#cloud-config\n"+s},getUserData(e){try{let t=this.userScript?i["a"].parseDocument(this.userScript):i["a"].parseDocument({});const s=this.mergeSSHAuthorizedKeys(this.userScript);s.length>0?t.setIn(["ssh_authorized_keys"],s):i["a"].isCollection(t.getIn("ssh_authorized_keys"))&&t.deleteIn(["ssh_authorized_keys"]),t=e.installAgent?this.mergeQGA({userDataDoc:t,...e}):this.deleteQGA({userDataDoc:t,...e});const a=t.toString();if("{}\n"===a)return;return a}catch(t){return console.error("Error: Unable to parse yaml document",t),this.userScript}},updateSSHKey(e){this.$set(this,"sshKey",e)},updateCpuMemory(e,t){this.$set(this,"cpu",e),this.$set(this,"memory",t)},parseDisk(e,t){const s={name:e.name};return e.type===$?s.disk={bus:e.bus}:e.type===C&&(s.cdrom={bus:e.bus}),s.bootOrder=t+1,s},parseVolume(e,t){const s={name:e.name};return e.source===S["f"].CONTAINER?s.containerDisk={image:e.container}:e.source!==S["f"].IMAGE&&e.source!==S["f"].NEW&&e.source!==S["f"].ATTACH_VOLUME||(s.persistentVolumeClaim={claimName:t},e.hotpluggable&&(s.persistentVolumeClaim.hotpluggable=!0)),s},parseVolumeClaimTemplate(e,t){!String(e.size).includes("Gi")&&e.size&&(e.size=e.size+"Gi");const s={metadata:{name:t},spec:{accessModes:[e.accessMode],resources:{requests:{storage:e.size}},volumeMode:e.volumeMode}};switch(e.dataSource&&(s.spec.dataSource=e.dataSource),e.source){case S["f"].ATTACH_VOLUME:s.spec.storageClassName=e.storageClassName;break;case S["f"].NEW:s.spec.storageClassName=e.storageClassName;break;case S["f"].IMAGE:{const t=this.images.find(t=>e.image===t.id);t?(s.spec.storageClassName="longhorn-"+t.metadata.name,s.metadata.annotations={[k["a"].IMAGE_ID]:t.id}):s.metadata.annotations={[k["a"].IMAGE_ID]:""};break}}return s},getSSHListValue(e){return e.map(e=>this.getSSHValue(e)).filter(e=>void 0!==e)},parseInterface(e){const t={},s=e.type;return t[s]={},e.macAddress&&(t.macAddress=e.macAddress),t.model=e.model,t.name=e.name,t},parseNetwork(e){const t={name:e.name};return e.isPod?t.pod={}:t.multus={networkName:e.networkName},t},updateUserData(e){this.userScript=e},updateNetworkData(e){this.networkScript=e},mergeSSHAuthorizedKeys(e){try{var t;const s=(null===(t=i["a"].parseDocument(e).get("ssh_authorized_keys"))||void 0===t?void 0:t.toJSON())||[],a=this.getSSHListValue(this.sshKey);return s.length?[...new Set([...a,...s])]:a}catch(s){return[]}},deleteYamlDocProp(e,t){try{var s,i;const a=null===(s=e.getIn([]))||void 0===s?void 0:s.items[0],o=null===a||void 0===a?void 0:a.key,n=!(null===o||void 0===o||null===(i=o.commentBefore)||void 0===i||!i.includes("cloud-config")),r=o.source===t[t.length-1];o&&n&&r||e.deleteIn(t)}catch(a){}},mergeQGA(e){const{osType:t,userDataDoc:s}=e,a=this.getMatchQGA(t),o=s.toString(),n=i["a"].parse(o);let r=(null===n||void 0===n?void 0:n.packages)||[],l=(null===n||void 0===n?void 0:n.runcmd)||[];if(s.setIn(["package_update"],!0),Array.isArray(r)?r.includes("qemu-guest-agent")||r.push("qemu-guest-agent"):r=w["a"].packages,Array.isArray(l)){let e=-1;const s=l.find(e=>Array.isArray(e)&&e.join("-")===a.runcmd[0].join("-")),i=l.find((s,i)=>!(!Array.isArray(s)||s.join("-")!==this.getSimilarRuncmd(t).join("-"))&&(e=i,!0));i?l[e]=a.runcmd[0]:s||l.push(a.runcmd[0])}else l=a.runcmd;return r.length>0?s.setIn(["packages"],r):(s.setIn(["packages"],[]),this.deleteYamlDocProp(s,["packages"]),this.deleteYamlDocProp(s,["package_update"])),l.length>0?s.setIn(["runcmd"],l):this.deleteYamlDocProp(s,["runcmd"]),s},deleteQGA(e){var t,s;const{osType:a,userDataDoc:o,deletePackage:n=!1}=e,r=(null===(t=this.$store.getters["harvester/byId"](b["e"],this.userDataTemplateId))||void 0===t||null===(s=t.data)||void 0===s?void 0:s.cloudInit)||"",l=o.toString(),d=i["a"].parse(l),c=(null===d||void 0===d?void 0:d.packages)||[],u=(null===d||void 0===d?void 0:d.runcmd)||[];if(Array.isArray(c)&&n){const e=this.convertToJson(r);for(let t=0;t<c.length;t++)"qemu-guest-agent"===c[t]&&(Array.isArray(null===e||void 0===e?void 0:e.packages)&&e.packages.includes("qemu-guest-agent")||c.splice(t,1))}if(Array.isArray(u)){const e=this.getMatchQGA(a);for(let t=0;t<u.length;t++)Array.isArray(u[t])&&u[t].join("-")===e.runcmd[0].join("-")&&u.splice(t,1)}return c.length>0?o.setIn(["packages"],c):(o.setIn(["packages"],[]),this.deleteYamlDocProp(o,["packages"]),this.deleteYamlDocProp(o,["package_update"])),u.length>0?o.setIn(["runcmd"],u):this.deleteYamlDocProp(o,["runcmd"]),o},generateSecretName(e){return e?`${e}-${Object(v["p"])(5).toLowerCase()}`:void 0},getOwnerReferencesFromVM(e){var t;const s=e.metadata.name,i=e.kind,a=this.resource===A["b"].VM?"kubevirt.io/v1":"harvesterhci.io/v1beta1",o=null===e||void 0===e||null===(t=e.metadata)||void 0===t?void 0:t.uid;return[{name:s,kind:i,uid:o,apiVersion:a}]},async saveSecret(e){if(null===e||void 0===e||!e.spec||!this.secretName||this.isWindows)return!0;let t=this.getSecret(e.spec);!t&&this.isEdit&&this.secretRef&&(t=this.secretRef),t&&!this.needNewSecret||(t=await this.$store.dispatch("harvester/create",{metadata:{name:this.secretName,namespace:this.value.metadata.namespace,labels:{[k["a"].CLOUD_INIT]:"harvester"},ownerReferences:this.getOwnerReferencesFromVM(e)},type:b["J"]}));try{t&&(this.saveUserDataAsClearText&&this.saveNetworkDataAsClearText||(t.setData("userdata",this.userData||""),t.setData("networkdata",this.networkScript||""),await t.save()))}catch(s){return Promise.reject(s)}},async saveAccessCredentials(e){if(null===e||void 0===e||!e.spec)return!0;const t=[];for(const i of this.accessCredentials){let s=i.secretRef;if(s&&!this.needNewSecret||(s=await this.$store.dispatch("harvester/create",{metadata:{name:i.secretName,namespace:e.metadata.namespace,labels:{[k["a"].CLOUD_INIT]:"harvester"},ownerReferences:this.getOwnerReferencesFromVM(e)},type:b["J"]})),i.source===S["a"].RESET_PWD&&s.setData(i.username,i.newPassword),i.source===S["a"].INJECT_SSH)for(const e of i.sshkeys){const t=(this.$store.getters["harvester/all"](A["b"].SSH)||[]).find(t=>t.id===e);s.setData(`${t.metadata.namespace}-${t.metadata.name}`,t.spec.publicKey)}t.push(s)}try{for(const e of t)await e.save()}catch(s){return Promise.reject(s)}},getAccessCredentialsValidation(){const e=[];for(let t=0;t<this.accessCredentials.length;t++){const s=this.accessCredentials[t],i=s.source;if(i===S["a"].RESET_PWD){if(!s.username){const t=this.t("harvester.virtualMachine.input.username"),s=this.t("validation.required",{key:t});e.push(s)}if(!s.newPassword){const t=this.t("harvester.virtualMachine.input.password"),s=this.t("validation.required",{key:t});e.push(s)}if(s.newPassword&&s.newPassword.length<6){const t=this.t("harvester.virtualMachine.input.password"),s=this.t("validation.number.min",{key:t,val:"6"});e.push(s)}}else{if(!s.users||0===s.users.length){const t=this.t("harvester.virtualMachine.input.username"),s=this.t("validation.required",{key:t});e.push(s)}if(!s.sshkeys||0===s.sshkeys.length){const t=this.t("harvester.virtualMachine.input.sshKeyValue"),s=this.t("validation.required",{key:t});e.push(s)}}if(e.length>0)break}return e},getHasCreatedVolumes(e){const t=[];return e.template.spec.volumes&&e.template.spec.volumes.forEach(e=>{var s;null!==e&&void 0!==e&&null!==(s=e.persistentVolumeClaim)&&void 0!==s&&s.claimName&&t.push(e.persistentVolumeClaim.claimName)}),t},handlerUSBTablet(e){var t;const s=this.isInstallUSBTablet(this.spec),i=(null===(t=this.spec.template.spec.domain.devices)||void 0===t?void 0:t.inputs)||[];if(e&&!s)i.length>0?i.push(w["b"][0]):Object.assign(this.spec.template.spec.domain.devices,{inputs:[w["b"][0]]});else if(!e){const e=i.findIndex(e=>r()(e,w["b"][0]));s&&1===i.length?this.$delete(this.spec.template.spec.domain.devices,"inputs"):s&&(i.splice(e,1),this.$set(this.spec.template.spec.domain.devices,"inputs",i))}},setBootMethod(e={efi:!1,secureBoot:!1}){if(e.efi&&e.secureBoot)Object(m["j"])(this.spec.template.spec.domain,"features.smm.enabled",!0),Object(m["j"])(this.spec.template.spec.domain,"firmware.bootloader.efi.secureBoot",!0);else if(e.efi&&!e.secureBoot){try{this.$delete(this.spec.template.spec.domain.features.smm,"enabled");const e=0===Object.keys(this.spec.template.spec.domain.features.smm).length;e&&this.$delete(this.spec.template.spec.domain.features,"smm")}catch(t){}Object(m["j"])(this.spec.template.spec.domain,"firmware.bootloader.efi.secureBoot",!1)}else this.$delete(this.spec.template.spec.domain,"firmware"),this.$delete(this.spec.template.spec.domain.features,"smm")},setTPM(e){e?Object(m["j"])(this.spec.template.spec.domain.devices,"tpm",{}):this.$delete(this.spec.template.spec.domain.devices,"tpm")},deleteSSHFromUserData(e=[]){const t=this.getSSHFromUserData(this.userScript);e.map(e=>{const s=t.findIndex(t=>t===this.getSSHValue(e));s>=0&&t.splice(s,1)});const s=this.convertToJson(this.userScript);s.ssh_authorized_keys=t,0===t.length&&delete s.ssh_authorized_keys,d()(s)?this.$set(this,"userScript",void 0):this.$set(this,"userScript",o.a.dump(s)),this.refreshYamlEditor()},refreshYamlEditor(){this.$nextTick(()=>{var e;null===(e=this.$refs.yamlEditor)||void 0===e||e.updateValue()})},toggleAdvanced(){this.showAdvanced=!this.showAdvanced},updateAgent(e){e||(this.deletePackage=!0)},updateDataTemplateId(e,t){if("user"===e){const e=this.installAgent;this.userDataTemplateId=t,this.$nextTick(()=>{e&&(this.installAgent=e)})}},updateReserved(e={}){const{memory:t}=e;this.$set(this,"reservedMemory",t)},updateTerminationGracePeriodSeconds(e){this.$set(this,"terminationGracePeriodSeconds",e)}},watch:{diskRows:{handler(e,t){if(Array.isArray(e)){var s,i;const a=null===(s=e[0])||void 0===s?void 0:s.image,o=this.images.find(e=>a===e.id),n=null===o||void 0===o?void 0:o.imageOSType,r=null===(i=t[0])||void 0===i?void 0:i.image;this.isCreate&&r===a&&a&&(this.osType=n)}}},secretRef:{handler(e){e&&this.resource!==A["b"].BACKUP&&(this.secretName=null===e||void 0===e?void 0:e.metadata.name)},immediate:!0,deep:!0},isWindows(e){e&&(this.$set(this,"sshKey",[]),this.$set(this,"userScript",void 0),this.$set(this,"installAgent",!1))},installUSBTablet(e){this.handlerUSBTablet(e)},efiEnabled(e){this.setBootMethod({efi:e,secureBoot:this.secureBoot})},secureBoot(e){this.setBootMethod({efi:this.efiEnabled,secureBoot:e})},tpmEnabled(e){this.setTPM(e)},installAgent:{handler(e){if(this.deleteAgent){let t=this.getUserData({installAgent:e,osType:this.osType,deletePackage:this.deletePackage});if(e){const e=this.hasCloudConfigComment(t);e||(t="#cloud-config\n"+t)}this.$set(this,"userScript",t),this.refreshYamlEditor()}this.deleteAgent=!0,this.deletePackage=!1}},osType(e){const t=this.getUserData({installAgent:this.installAgent,osType:e});this.$set(this,"userScript",t),this.refreshYamlEditor()},userScript(e,t){const s=this.hasInstallAgent(e,this.osType,this.installAgent);s!==this.installAgent&&(this.deleteAgent=!1,this.installAgent=s)},sshKey(e,t){const s=u()(t,e);s.length&&this.isEdit&&this.deleteSSHFromUserData(s)}}}}}]);
//# sourceMappingURL=harvester-v1.2.1.umd.min.detail~edit~formatters.js.map